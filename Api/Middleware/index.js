const jwt = require('jsonwebtoken')
const User = require('../Models/user.model')


function checkAuth(req, res, next) {         //checkeamos autenticaci칩n, si el usuario est치 logueado y tiene token

    if (!req.headers.authorization) return res.status(401).send('Token not found')       // comprobamos que nos envia el token en el req.headers

    jwt.verify(req.headers.authorization, process.env.SECRET, async (err, result) => {
        if (err) return res.status(401).send('Token not valid')

        const user = await User.findOne({ where: { email: result.email } })
        if (!user) return res.status(401).send('User not found')

        res.locals.user = user

        next()
    })
}


function checkAdmin(req, res, next) {       //checkeamos autorizaci칩n, si el usuario tiene acceso o no a un recurso

    if (res.locals.user.role !== 'admin') {
        return res.status(401).send('User not authorized')

    } else {
        next()
    }
}
function checkRelative(req, res, next) {       //checkeamos autorizaci칩n, si el usuario tiene acceso o no a un recurso
    console.log(res.locals.user.role)
    if (res.locals.user.role === 'relative' || res.locals.user.role === 'admin') {
        next()
    } else {
        return res.status(401).send('User not authorized')
    }
}


module.exports = { checkAuth, checkAdmin , checkRelative}